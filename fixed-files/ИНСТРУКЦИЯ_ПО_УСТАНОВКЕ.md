# Инструкция по установке исправлений Construction CRM

## Шаг 1: Остановка сервера
```bash
# Найти процесс Node.js
ps aux | grep node

# Остановить сервер (замените PID на актуальный)
kill -9 [PID]

# Или если запущен через PM2
pm2 stop construction-crm
```

## Шаг 2: Создание резервной копии
```bash
cd /root
cp -r construction-crm construction-crm-backup
```

## Шаг 3: Замена файлов

### 3.1 Замена auth.js
```bash
cd /root/construction-crm
cp fixed-files/public/js/auth.js public/js/auth.js
```

### 3.2 Создание mock-database.js
```bash
cp fixed-files/mock-database.js mock-database.js
```

### 3.3 Обновление server.js

**Вариант А: Ручное редактирование**
1. Откройте файл `/root/construction-crm/server.js`
2. Добавьте в начало файла после других require:
```javascript
const MockDatabase = require('./mock-database');
```

3. Найдите строку `const PORT = process.env.PORT || 3000;` и добавьте после неё:
```javascript
// Устанавливаем JWT_SECRET если не задан
if (!process.env.JWT_SECRET) {
  process.env.JWT_SECRET = 'construction-crm-secret-key-2024';
}
```

4. Замените функцию `connectDB()`:
```javascript
let db;
async function connectDB() {
  try {
    db = await mysql.createConnection(dbConfig);
    logger.info('Connected to MySQL database');
  } catch (error) {
    logger.error('Database connection failed, using mock database:', error);
    // Используем mock базу данных при отсутствии подключения
    db = new MockDatabase();
    logger.info('Using mock database for development');
  }
}
```

5. Найдите раздел `// ДАШБОРД` и добавьте ПЕРЕД ним код из файла `fixed-files/server-additions.js` (начиная с "// ПОДРЯДЧИКИ")

**Вариант Б: Полная замена (если есть полный исправленный файл)**
```bash
cp fixed-files/server.js server.js
```

### 3.4 Обновление app.js
1. Откройте файл `/root/construction-crm/public/js/app.js`
2. Найдите метод `init()` в классе `ConstructionCRM`
3. Замените его содержимое на код из файла `fixed-files/app-js-changes.js`

## Шаг 4: Проверка файлов
```bash
# Проверить, что файлы созданы
ls -la /root/construction-crm/mock-database.js
ls -la /root/construction-crm/public/js/auth.js

# Проверить изменения в server.js
grep "MockDatabase" /root/construction-crm/server.js
grep "JWT_SECRET" /root/construction-crm/server.js
```

## Шаг 5: Запуск сервера
```bash
cd /root/construction-crm
node server.js
```

**Или через PM2:**
```bash
pm2 start server.js --name construction-crm
pm2 logs construction-crm
```

## Шаг 6: Проверка работы

1. Откройте браузер и перейдите на http://79.174.85.87:3000
2. Войдите с логином: `admin` и паролем: `admin123`
3. Проверьте, что:
   - ✅ Логин проходит успешно
   - ✅ Дашборд загружается без ошибок
   - ✅ Навигация между модулями работает
   - ✅ В консоли браузера нет ошибок JavaScript

## Возможные проблемы

### Проблема: "Cannot find module './mock-database'"
**Решение:** Убедитесь, что файл `mock-database.js` находится в корне проекта `/root/construction-crm/`

### Проблема: "JWT_SECRET is not defined"
**Решение:** Добавьте проверку JWT_SECRET в server.js как указано в инструкции

### Проблема: Сервер не запускается
**Решение:** 
1. Проверьте логи: `tail -f /root/construction-crm/logs/error.log`
2. Убедитесь, что все зависимости установлены: `npm install`
3. Проверьте синтаксис JavaScript: `node -c server.js`

### Проблема: Порт занят
**Решение:**
```bash
# Найти процесс на порту 3000
lsof -i :3000

# Остановить процесс
kill -9 [PID]
```

## Откат изменений (если что-то пошло не так)
```bash
cd /root
rm -rf construction-crm
mv construction-crm-backup construction-crm
cd construction-crm
node server.js
```

## Логи для отладки
```bash
# Логи сервера
tail -f /root/construction-crm/logs/combined.log

# Логи ошибок
tail -f /root/construction-crm/logs/error.log

# Логи PM2 (если используется)
pm2 logs construction-crm
```

---
**После успешной установки система должна работать с логином admin/admin123!**