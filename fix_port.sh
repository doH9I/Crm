#!/bin/bash

echo "=== Port 3000 Fix Script ==="
echo "–ò—Å–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–æ–±–ª–µ–º—É –∑–∞–Ω—è—Ç–æ–≥–æ –ø–æ—Ä—Ç–∞ 3000..."

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –Ω–∞ –ø–æ—Ä—Ç—É 3000
find_port_processes() {
    echo "1. –ò—â–µ–º –ø—Ä–æ—Ü–µ—Å—Å—ã, –∏—Å–ø–æ–ª—å–∑—É—é—â–∏–µ –ø–æ—Ä—Ç 3000..."
    
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–µ—Ç–æ–¥–æ–≤ –¥–ª—è –ø–æ–∏—Å–∫–∞
    echo "--- –ü—Ä–æ—Ü–µ—Å—Å—ã –Ω–∞ –ø–æ—Ä—Ç—É 3000 (netstat): ---"
    netstat -tulpn | grep :3000 || echo "–ù–µ –Ω–∞–π–¥–µ–Ω–æ —á–µ—Ä–µ–∑ netstat"
    
    echo ""
    echo "--- –ü—Ä–æ—Ü–µ—Å—Å—ã –Ω–∞ –ø–æ—Ä—Ç—É 3000 (ss): ---"
    ss -tulpn | grep :3000 || echo "–ù–µ –Ω–∞–π–¥–µ–Ω–æ —á–µ—Ä–µ–∑ ss"
    
    echo ""
    echo "--- –ü—Ä–æ—Ü–µ—Å—Å—ã –Ω–∞ –ø–æ—Ä—Ç—É 3000 (lsof): ---"
    lsof -i :3000 || echo "–ù–µ –Ω–∞–π–¥–µ–Ω–æ —á–µ—Ä–µ–∑ lsof"
    
    echo ""
    echo "--- –í—Å–µ –ø—Ä–æ—Ü–µ—Å—Å—ã Node.js: ---"
    ps aux | grep node | grep -v grep || echo "Node.js –ø—Ä–æ—Ü–µ—Å—Å—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
stop_processes() {
    echo ""
    echo "2. –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å—ã..."
    
    # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ –ø—Ä–æ—Ü–µ—Å—Å—ã Node.js
    echo "–û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ Node.js –ø—Ä–æ—Ü–µ—Å—Å—ã..."
    pkill -f node
    sleep 2
    
    # –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —É–±–∏–≤–∞–µ–º –µ—Å–ª–∏ –æ—Å—Ç–∞–ª–∏—Å—å
    echo "–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ—Å—Ç–∞–≤—à–∏–µ—Å—è –ø—Ä–æ—Ü–µ—Å—Å—ã..."
    pkill -9 -f node
    sleep 1
    
    # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å—ã –Ω–∞ –ø–æ—Ä—Ç—É 3000
    echo "–û—Å–≤–æ–±–æ–∂–¥–∞–µ–º –ø–æ—Ä—Ç 3000..."
    PID=$(lsof -t -i :3000 2>/dev/null)
    if [ ! -z "$PID" ]; then
        echo "–ù–∞–π–¥–µ–Ω –ø—Ä–æ—Ü–µ—Å—Å –Ω–∞ –ø–æ—Ä—Ç—É 3000: PID $PID"
        kill -9 $PID
        echo "–ü—Ä–æ—Ü–µ—Å—Å –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
    else
        echo "–ü—Ä–æ—Ü–µ—Å—Å—ã –Ω–∞ –ø–æ—Ä—Ç—É 3000 –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
    fi
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏—è –ø–æ—Ä—Ç–∞
check_port_free() {
    echo ""
    echo "3. –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ –ø–æ—Ä—Ç–∞..."
    sleep 2
    
    if netstat -tulpn | grep :3000 > /dev/null; then
        echo "‚ùå –ü–æ—Ä—Ç 3000 –≤—Å–µ –µ—â–µ –∑–∞–Ω—è—Ç!"
        return 1
    else
        echo "‚úÖ –ü–æ—Ä—Ç 3000 —Å–≤–æ–±–æ–¥–µ–Ω!"
        return 0
    fi
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ–≥–æ —Ä–µ—à–µ–Ω–∏—è
alternative_port() {
    echo ""
    echo "=== –ê–õ–¨–¢–ï–†–ù–ê–¢–ò–í–ù–û–ï –†–ï–®–ï–ù–ò–ï ==="
    echo "–ï—Å–ª–∏ –ø–æ—Ä—Ç 3000 –Ω–µ –æ—Å–≤–æ–±–æ–∂–¥–∞–µ—Ç—Å—è, –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥—Ä—É–≥–æ–π –ø–æ—Ä—Ç:"
    echo ""
    echo "1. –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ .env —Ñ–∞–π–ª:"
    echo "   nano .env"
    echo "   –ò–∑–º–µ–Ω–∏—Ç–µ PORT=3000 –Ω–∞ PORT=3001"
    echo ""
    echo "2. –ò–ª–∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å –¥—Ä—É–≥–∏–º –ø–æ—Ä—Ç–æ–º:"
    echo "   PORT=3001 node server.js"
    echo "   PORT=3002 node server.js"
    echo ""
    echo "3. –¢–æ–≥–¥–∞ —Å–∞–π—Ç –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ –∞–¥—Ä–µ—Å—É:"
    echo "   http://79.174.85.87:3001"
}

# –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è
main() {
    echo "–ù–∞—á–∏–Ω–∞–µ–º –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ..."
    
    # –ù–∞—Ö–æ–¥–∏–º –ø—Ä–æ—Ü–µ—Å—Å—ã
    find_port_processes
    
    # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å—ã
    stop_processes
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
    if check_port_free; then
        echo ""
        echo "üéâ –£–°–ü–ï–•! –ü–æ—Ä—Ç 3000 –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω."
        echo "–¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–µ—Ä:"
        echo "  ./start_server.sh"
        echo ""
        echo "–ò–ª–∏ –∑–∞–ø—É—Å—Ç–∏—Ç—å –Ω–∞–ø—Ä—è–º—É—é:"
        echo "  node server.js"
    else
        echo ""
        echo "‚ö†Ô∏è  –ü–æ—Ä—Ç –≤—Å–µ –µ—â–µ –∑–∞–Ω—è—Ç."
        alternative_port
    fi
    
    echo ""
    echo "=== –ü–û–õ–ï–ó–ù–´–ï –ö–û–ú–ê–ù–î–´ ==="
    echo "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ—Ä—Ç 3000:"
    echo "  netstat -tulpn | grep :3000"
    echo "  lsof -i :3000"
    echo ""
    echo "–ù–∞–π—Ç–∏ –≤—Å–µ Node.js –ø—Ä–æ—Ü–µ—Å—Å—ã:"
    echo "  ps aux | grep node"
    echo ""
    echo "–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Å–µ Node.js –ø—Ä–æ—Ü–µ—Å—Å—ã:"
    echo "  pkill -f node"
    echo ""
    echo "–ó–∞–ø—É—Å—Ç–∏—Ç—å –Ω–∞ –¥—Ä—É–≥–æ–º –ø–æ—Ä—Ç—É:"
    echo "  PORT=3001 node server.js"
}

# –ó–∞–ø—É—Å–∫–∞–µ–º –æ—Å–Ω–æ–≤–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é
main